---
/**
 * 后台首页
 * - 展示文章列表
 * - 提供发布按钮
 * - 所有数据来自 Workers API
 * - 受 Cloudflare Access 保护
 */

// Cloudflare Access 验证
const accessJwt = Astro.request.headers.get('Cf-Access-Jwt-Assertion');
if (!accessJwt) {
  return Astro.redirect('/login', 302);
}
---

<h1>文章管理</h1>
<a href="/admin/edit">➕ 新建文章</a>
<div id="list"></div>

<script type="module">
import { api } from './assets/api';

const list = document.getElementById('list');
const posts = await api.getPosts();

list.innerHTML = posts.map(p =>
  `<div>
     <b>${p.title}</b> [${p.status}]
     <button onclick="publish(${p.id})">发布</button>
   </div>`
).join('');

window.publish = async id => {
  await api.publish(id);
  location.reload();
};
</script>
