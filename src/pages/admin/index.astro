---
/**
 * 后台首页
 * - 展示文章列表
 * - 提供发布按钮
 * - 所有数据来自 Workers API
 * - 受 Cloudflare Access 保护
 */


---

<h1>文章管理</h1>
<a href="/admin/edit">➕ 新建文章</a>
<div id="list"></div>

<script type="module">
// API configuration
const API = 'https://jiaweidao-workers.xxoo443.workers.dev/';

const api = {
  getPosts(): Promise<any[]> {
    return fetch(`${API}/posts`, {
      credentials: 'include'
    }).then(r => r.json());
  },
  save(data: Record<string, any>): Promise<Response> {
    return fetch(`${API}/posts`, {
      method: 'POST',
      headers: { 'Content-Type': 'application/json' },
      body: JSON.stringify(data),
      credentials: 'include'
    });
  },
  publish(id: string | number): Promise<Response> {
    return fetch(`${API}/publish/${id}`, {
      method: 'POST',
      credentials: 'include'
    });
  },
  uploadImage(file: File): Promise<{ success: boolean; url?: string; error?: string }> {
    const formData = new FormData();
    formData.append('image', file);
    return fetch(`${API}/upload`, {
      method: 'POST',
      body: formData,
      credentials: 'include'
    }).then(r => r.json());
  }
};

const list = document.getElementById('list');
const posts = await api.getPosts();

list.innerHTML = posts.map(p =>
  `<div>
     <b>${p.title}</b> [${p.status}]
     <button onclick="publish(${p.id})">发布</button>
   </div>`
).join('');

window.publish = async id => {
  await api.publish(id);
  location.reload();
};
</script>
