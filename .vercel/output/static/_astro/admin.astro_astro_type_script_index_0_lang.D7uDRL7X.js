document.addEventListener("DOMContentLoaded",function(){var t=new Date,n=t.toISOString().slice(0,16);const e=document.getElementById("post-date");e&&(e.value=n),Y()});function Y(){localStorage.getItem("authToken")?window.showAdminPanel():window.showLoginPage()}window.showLoginPage=function(){const t=document.getElementById("login-page"),n=document.getElementById("register-page"),e=document.getElementById("reset-password-page"),o=document.getElementById("admin-panel");t&&(t.style.display="block"),n&&(n.style.display="none"),e&&(e.style.display="none"),o&&(o.style.display="none")};window.showRegisterPage=function(){const t=document.getElementById("login-page"),n=document.getElementById("register-page"),e=document.getElementById("reset-password-page"),o=document.getElementById("admin-panel");t&&(t.style.display="none"),n&&(n.style.display="block"),e&&(e.style.display="none"),o&&(o.style.display="none")};window.showResetPasswordPage=function(){const t=document.getElementById("login-page"),n=document.getElementById("register-page"),e=document.getElementById("reset-password-page"),o=document.getElementById("admin-panel");t&&(t.style.display="none"),n&&(n.style.display="none"),e&&(e.style.display="block"),o&&(o.style.display="none")};window.showAdminPanel=function(){const t=document.getElementById("login-page"),n=document.getElementById("register-page"),e=document.getElementById("reset-password-page"),o=document.getElementById("admin-panel");t&&(t.style.display="none"),n&&(n.style.display="none"),e&&(e.style.display="none"),o&&(o.style.display="block")};window.openTab=function(t,n){var e,o,a;for(o=document.getElementsByClassName("tab-content"),e=0;e<o.length;e++){const i=o[e];i&&(i.style.display="none")}for(a=document.getElementsByClassName("tab"),e=0;e<a.length;e++){const i=a[e];i&&(i.className=i.className.replace(" active",""))}const r=document.getElementById(n);if(r&&(r.style.display="block"),t&&t.currentTarget){const i=t.currentTarget;i.className+=" active"}};function s(t,n,e){const o=document.getElementById(t);o&&(o.innerHTML='<div class="alert '+e+'">'+n+"</div>",setTimeout(function(){const a=document.getElementById(t);a&&(a.innerHTML="")},3e3))}window.login=async function(){const t=document.getElementById("login-email"),n=document.getElementById("login-password");if(!t||!n){s("login-alert","请输入邮箱和密码","error");return}const e=t.value,o=n.value;if(!e||!o){s("login-alert","请输入邮箱和密码","error");return}try{const r=await(await fetch("/api/login",{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({email:e,password:o})})).json();r.success?(localStorage.setItem("authToken",r.token),localStorage.setItem("userEmail",r.email),window.showAdminPanel()):s("login-alert",r.error,"error")}catch(a){const r=a instanceof Error?a.message:"未知错误";s("login-alert","登录失败: "+r,"error")}};window.register=async function(){const t=document.getElementById("register-email"),n=document.getElementById("register-password");if(!t||!n){s("register-alert","请输入邮箱和密码","error");return}const e=t.value,o=n.value;if(!e||!o){s("register-alert","请输入邮箱和密码","error");return}if(!e.endsWith("@gmail.com")){s("register-alert","只能使用Gmail邮箱注册","error");return}if(o.length<6){s("register-alert","密码长度不能少于6位","error");return}try{const r=await(await fetch("/api/register",{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({email:e,password:o})})).json();r.success?(s("register-alert","注册成功，请登录","success"),setTimeout(()=>{window.showLoginPage()},2e3)):s("register-alert",r.error,"error")}catch(a){const r=a instanceof Error?a.message:"未知错误";s("register-alert","注册失败: "+r,"error")}};window.resetPassword=async function(){const t=document.getElementById("reset-email"),n=document.getElementById("reset-current-password"),e=document.getElementById("reset-new-password");if(!t||!n||!e){s("reset-alert","请填写所有字段","error");return}const o=t.value,a=n.value,r=e.value;if(!o||!a||!r){s("reset-alert","请填写所有字段","error");return}if(r.length<6){s("reset-alert","新密码长度不能少于6位","error");return}try{const d=await(await fetch("/api/resetPassword",{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({email:o,currentPassword:a,newPassword:r})})).json();d.success?(s("reset-alert","密码重置成功，请重新登录","success"),setTimeout(()=>{window.showLoginPage()},2e3)):s("reset-alert",d.error,"error")}catch(i){const d=i instanceof Error?i.message:"未知错误";s("reset-alert","密码重置失败: "+d,"error")}};window.logout=function(){localStorage.removeItem("authToken"),localStorage.removeItem("userEmail"),window.showLoginPage()};window.savePost=async function(){const t=document.getElementById("post-title"),n=document.getElementById("post-meta-title"),e=document.getElementById("post-description"),o=document.getElementById("post-date"),a=document.getElementById("post-youtube"),r=document.getElementById("post-image"),i=document.getElementById("post-categories"),d=document.getElementById("post-authors"),g=document.getElementById("post-draft"),w=document.getElementById("post-views"),E=document.getElementById("post-content"),h=document.getElementById("post-quote");if(!t||!n||!e||!o||!a||!r||!i||!d||!g||!w||!E||!h){s("posts-alert","表单元素加载失败，请刷新页面重试","error");return}const p=t.value,I=n.value,B=e.value,F=o.value,v=a.value,P=r.files?.[0],b=i.value,T=d.value,H=g.checked;let y=w.value;const Q=E.value,S=h.value;if(!p){s("posts-alert","请输入文章标题","error");return}if(!b){s("posts-alert","请选择分类","error");return}y||(y="0");let f="";if(P){const m=new FormData;m.append("image",P);try{const u=await(await fetch("/api/uploadImage",{method:"POST",body:m})).json();if(u.success)f=u.fileUrl;else{s("posts-alert","图片上传失败: "+u.error,"error");return}}catch(c){const u=c instanceof Error?c.message:"未知错误";s("posts-alert","图片上传失败: "+u,"error");return}}let l=`---
title: "`+p+`"
`;I?l+='meta_title: "'+I+`"
`:l+=`meta_title: ""
`,B?l+='description: "'+B+`"
`:l+=`description: "meta description"
`;const R=new Date(F).toISOString();if(l+="date: "+R+`
`,v&&(l+='youtube: "'+v+`"
`),f&&(l+='image: "'+f+`"
`),l+='categories: ["'+b+`"]
`,T){const m=T.split(",").map(function(c){return c.trim()});l+="authors: ["+m.map(function(c){return'"'+c+'"'}).join(", ")+`]
`}else l+=`authors: ["Admin"]
`;l+="draft: "+H+`
`,l+="views: "+y+`
`,l+=`---

`,S&&(l+="> "+S+`

`),l+=Q;try{const c=await(await fetch("/api/savePost",{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({title:p,markdownContent:l})})).json();if(c.success){s("posts-alert","文章保存成功！文件名："+c.fileName,"success");const u=document.getElementById("post-title"),k=document.getElementById("post-meta-title"),D=document.getElementById("post-description"),C=document.getElementById("post-youtube"),O=document.getElementById("post-image"),N=document.getElementById("post-categories"),j=document.getElementById("post-authors"),A=document.getElementById("post-draft"),L=document.getElementById("post-views"),M=document.getElementById("post-content"),J=document.getElementById("post-quote"),q=document.getElementById("post-date");u&&(u.value=""),k&&(k.value=""),D&&(D.value=""),C&&(C.value=""),O&&(O.value=""),N&&(N.value=""),j&&(j.value="John Doe"),A&&(A.checked=!1),L&&(L.value="0"),M&&(M.value=""),J&&(J.value="");const V=new Date().toISOString().slice(0,16);q&&(q.value=V)}else s("posts-alert","文章保存失败: "+c.error,"error")}catch(m){const c=m instanceof Error?m.message:"未知错误";s("posts-alert","文章保存失败: "+c,"error")}};window.saveAuthor=async function(){const t=document.getElementById("author-name"),n=document.getElementById("author-bio");if(!t||!n){s("authors-alert","表单元素加载失败，请刷新页面重试","error");return}const e=t.value,o=n.value;if(!e){s("authors-alert","请输入作者姓名","error");return}const a=`---
title: "`+e+`"
---

`+o;try{const i=await(await fetch("/api/saveAuthor",{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({name:e,markdownContent:a})})).json();if(i.success){s("authors-alert","作者保存成功！文件名："+i.fileName,"success");const d=document.getElementById("author-name"),g=document.getElementById("author-bio");d&&(d.value=""),g&&(g.value="")}else s("authors-alert","作者保存失败: "+i.error,"error")}catch(r){const i=r instanceof Error?r.message:"未知错误";s("authors-alert","作者保存失败: "+i,"error")}};
